<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard de Vendedores</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
nav { background:#1e3a8a; color:white; padding:10px; display:flex; gap:10px; }
nav button { background:#2563eb; border:none; padding:8px 12px; color:white; cursor:pointer; border-radius:6px; transition:0.3s; }
nav button:hover { background:#1d4ed8; }
.container { padding:20px; }
.card { background:white; border-radius:12px; padding:15px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.card h3 { margin:0 0 5px 0; }
.card p { margin:3px 0; }
.card button { margin-top:10px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; transition:0.3s; }
.btn-comissao { background:#ef4444; color:white; }
.btn-comissao:hover { background:#dc2626; }
.btn-voltar { background:#6b7280; color:white; margin-left:10px; }
.btn-voltar:hover { background:#4b5563; }
input, select { padding:8px; margin:5px 0; width:100%; border-radius:6px; border:1px solid #ccc; }
#comissaoModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
#comissaoModal .modal-content { background:white; padding:20px; border-radius:12px; width:350px; max-height:80%; overflow-y:auto; }
#comissaoModal button { margin-top:10px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; }
#comissaoModal .btn-fechar { background:#6b7280; color:white; }
#comissaoModal .btn-fechar:hover { background:#4b5563; }
#comissaoModal .btn-pagar { background:#10b981; color:white; }
#comissaoModal .btn-pagar:hover { background:#059669; }
.venda-item { display:flex; justify-content:space-between; align-items:center; padding:6px; border-bottom:1px solid #ddd; }
</style>
<script>
// ===================== CONFIG =====================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyauiAXm1X-Mkx4Tn-QpfpLhRhv0LWOTtufAfx3I7ICH32I4q1mYvuW6fg1NlpIzuE/exec';
let vendedores = [];
let vendas = [];
let vendedorParaPagar = null;

// ===================== UTILITÁRIOS =====================
const formatarMoeda = (valor) => `R$ ${parseFloat(valor).toFixed(2).replace('.', ',')}`;
const mostrarMensagem = (texto) => alert(texto);

// ===================== FETCH =====================
const fetchVendedores = async () => {
    try {
        const res = await fetch(`${SCRIPT_URL}?sheet=Vendedores`);
        const data = await res.json();
        vendedores = data.map(v => ({
            id: v.Id, nome: v.Nome, telefone: v.Telefone,
            cep: v.CEP, rua: v.Rua, numero: v.Numero,
            bairro: v.Bairro, cidade: v.Cidade
        }));
        abastecerVendedores();
        renderDashboard();
    } catch(e){console.error(e);}
};

const fetchVendas = async () => {
    try {
        const res = await fetch(`${SCRIPT_URL}?sheet=Vendas`);
        const data = await res.json();
        vendas = data.map(v => ({
            id: v.Id, vendedorId: v.id_vendedor,
            descricao: v.Descricao,
            valorTotal: parseFloat(v.ValorTotal),
            valorComissao: parseFloat(v.ValorComissao),
            tipoPagamento: v.TipoPagamento,
            valorEntrada: v.ValorEntrada || null,
            comissaoPaga: v.ComissaoPaga || false
        }));
        renderDashboard();
    } catch(e){console.error(e);}
};

// ===================== RENDER DASHBOARD =====================
const renderDashboard = () => {
    const dash = document.getElementById('dashboardContent');
    dash.innerHTML = '';
    let totalGeral = vendas.reduce((t,v)=>t+(v.valorTotal||0),0);
    document.getElementById('totalGeralVendas').textContent = formatarMoeda(totalGeral);

    vendedores.forEach(v => {
        const vendasVendedor = vendas.filter(s=>s.vendedorId===v.id);
        const pendente = vendasVendedor.filter(s=>!s.comissaoPaga).reduce((t,s)=>t+(s.valorComissao||0),0);
        const paga = vendasVendedor.filter(s=>s.comissaoPaga).reduce((t,s)=>t+(s.valorComissao||0),0);

        const card = document.createElement('div');
        card.className='card';
        card.innerHTML = `
            <h3>${v.nome}</h3>
            <p>${v.cidade || ''} - ${v.bairro || ''}</p>
            <p>Comissão Pendente: ${formatarMoeda(pendente)}</p>
            <p>Comissão Paga: ${formatarMoeda(paga)}</p>
            ${pendente>0?`<button class="btn-comissao" onclick="abrirModal(${v.id})">Pagar Comissão</button>`:''}
        `;
        dash.appendChild(card);
    });
};

// ===================== DROPDOWN =====================
const abastecerVendedores = () => {
    const select = document.getElementById('vendaVendedor');
    if(!select) return;
    select.innerHTML='<option value="">Selecione um vendedor</option>';
    vendedores.forEach(v=>{
        const opt=document.createElement('option');
        opt.value=v.id; opt.textContent=v.nome; select.appendChild(opt);
    });
};

// ===================== MODAL COMISSÃO =====================
const abrirModal = (id) => {
    vendedorParaPagar=id;
    const container = document.getElementById('vendasPendentesContainer');
    container.innerHTML='';
    const pendentes = vendas.filter(v=>v.vendedorId===id && !v.comissaoPaga);
    if(pendentes.length===0) {
        container.innerHTML='<p>Nenhuma comissão pendente.</p>';
    } else {
        pendentes.forEach(v=>{
            const div = document.createElement('div');
            div.className='venda-item';
            div.innerHTML = `
                <span>${v.descricao} (${formatarMoeda(v.valorComissao)})</span>
                <input type="checkbox" value="${v.id}" />
            `;
            container.appendChild(div);
        });
    }
    document.getElementById('comissaoModal').style.display='flex';
};

const fecharModal = () => { document.getElementById('comissaoModal').style.display='none'; };

// Pagar comissões selecionadas
const pagarComissoes = async () => {
    const checkboxes = document.querySelectorAll('#vendasPendentesContainer input[type="checkbox"]:checked');
    if(checkboxes.length===0){ mostrarMensagem('Selecione ao menos uma venda'); return; }

    const ids = Array.from(checkboxes).map(cb=>cb.value).join(',');
    try{
        await fetch(`${SCRIPT_URL}?action=pagarComissoes&ids=${ids}`);
        mostrarMensagem('Comissões pagas com sucesso!');
        fetchVendas();
        fecharModal();
    }catch(e){console.error(e);}
};

// ===================== NAVEGAÇÃO =====================
const mostrarDashboard = () => {
    document.getElementById('dashboardPage').style.display='block';
    document.getElementById('cadastroVendedorPage').style.display='none';
    document.getElementById('cadastroVendaPage').style.display='none';
};
const mostrarCadastroVendedor = () => {
    document.getElementById('dashboardPage').style.display='none';
    document.getElementById('cadastroVendedorPage').style.display='block';
    document.getElementById('cadastroVendaPage').style.display='none';
};
const mostrarCadastroVenda = () => {
    document.getElementById('dashboardPage').style.display='none';
    document.getElementById('cadastroVendedorPage').style.display='none';
    document.getElementById('cadastroVendaPage').style.display='block';
};

// ===================== FUNÇÕES DE CADASTRO =====================
const cadastrarVendedor = async () => {
    const nome = document.getElementById('nomeVendedor').value;
    const telefone = document.getElementById('telefoneVendedor').value;
    if(!nome) return mostrarMensagem('Digite o nome do vendedor');
    try{
        await fetch(`${SCRIPT_URL}?sheet=Vendedores&nome=${encodeURIComponent(nome)}&telefone=${encodeURIComponent(telefone)}`);
        mostrarMensagem('Vendedor cadastrado com sucesso!');
        document.getElementById('nomeVendedor').value=''; document.getElementById('telefoneVendedor').value='';
        fetchVendedores(); mostrarDashboard();
    }catch(e){console.error(e);}
};

const cadastrarVenda = async () => {
    const vendedorId = document.getElementById('vendaVendedor').value;
    const descricao = document.getElementById('descricaoVenda').value;
    const valorTotal = document.getElementById('valorVenda').value;
    if(!vendedorId || !descricao || !valorTotal) return mostrarMensagem('Preencha todos os campos');
    try{
        await fetch(`${SCRIPT_URL}?sheet=Vendas&vendedorId=${vendedorId}&descricao=${encodeURIComponent(descricao)}&valorTotal=${valorTotal}`);
        mostrarMensagem('Venda cadastrada com sucesso!');
        document.getElementById('descricaoVenda').value=''; document.getElementById('valorVenda').value='';
        fetchVendas(); mostrarDashboard();
    }catch(e){console.error(e);}
};

// ===================== INICIALIZAÇÃO =====================
window.addEventListener('DOMContentLoaded', ()=>{
    fetchVendedores();
    fetchVendas();
    mostrarDashboard();
});
</script>
</head>
<body>
<nav>
<button onclick="mostrarDashboard()">Dashboard</button>
<button onclick="mostrarCadastroVendedor()">Cadastrar Vendedor</button>
<button onclick="mostrarCadastroVenda()">Cadastrar Venda</button>
</nav>
<div class="container">

<!-- DASHBOARD -->
<div id="dashboardPage">
<h2>Dashboard</h2>
<p>Total Geral: <span id="totalGeralVendas">R$0,00</span></p>
<div id="dashboardContent"></div>
</div>

<!-- CADASTRO VENDEDOR -->
<div id="cadastroVendedorPage" style="display:none;">
<h2>Cadastro de Vendedor</h2>
<input id="nomeVendedor" placeholder="Nome" />
<input id="telefoneVendedor" placeholder="Telefone" />
<button onclick="cadastrarVendedor()">Cadastrar</button>
<button class="btn-voltar" onclick="mostrarDashboard()">Voltar</button>
</div>

<!-- CADASTRO VENDA -->
<div id="cadastroVendaPage" style="display:none;">
<h2>Cadastro de Venda</h2>
<select id="vendaVendedor"></select>
<input id="descricaoVenda" placeholder="Descrição" />
<input id="valorVenda" placeholder="Valor Total" />
<button onclick="cadastrarVenda()">Cadastrar</button>
<button class="btn-voltar" onclick="mostrarDashboard()">Voltar</button>
</div>

<!-- MODAL COMISSÃO -->
<div id="comissaoModal" style="display:flex; align-items:center; justify-content:center;">
<div class="modal-content">
<h3>Comissão do vendedor</h3>
<div id="vendasPendentesContainer"></div>
<button class="btn-pagar" onclick="pagarComissoes()">Pagar Comissões</button>
<button class="btn-fechar" onclick="fecharModal()">Fechar</button>
</div>
</div>

</div>
</body>
</html>
